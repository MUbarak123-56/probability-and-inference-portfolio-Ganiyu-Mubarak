---
title: "Order Statistics"
author: "Mubarak Ganiyu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: yes
    number_sections: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r global options, include = FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE, cache=TRUE)
```

```{r, include = FALSE}
library(tidyverse)
```

# Introduction


# Methods

```{r}
rm(list=ls()) 
dorder <- function(x) {
  100*
  choose(200,100)
  (pnorm(x, mean = 0, sd = 1))^(100-1)*
  (1-pnorm(x, mean = 0, sd = 1))^(200-100)*
  dnorm(x, mean = 0, sd = 1)
}

porder <- function(x) {
  pbinom(100-1, 200, pnorm(x, mean = 0, sd = 1), lower.tail = FALSE)
}

qorder <- function(p, n1, n2) {
  r <- curve(porder(x),n1,n2)
  m <- mean(r$x)
  sd <- sd(r$x)
  q <- c()
  for (i in seq_along(p)) {
    q[i] <- qnorm(p[i], mean = m, sd = sd)
  }
  df <- data.frame(p = p, q = q)
  return(df)
}
```


# Questions and Answers

Q: Begin with the median from a sample of N=200 from the standard normal distribution. Write an R function that is the density function for the median in this sample. Note that the 100th order statistic is approximately the median, and use the order statistic formula discussed in class. Generate a plot of the function.

```{r, fig.width = 10, fig.height = 7}
curve(dorder(x), -0.5, 0.5, col = "blue",
      main = "Probability density function of the median (100th order statistic)",
      xlab = "value",
      ylab = "density")
```

Q: Write an R function that is the probability function for the median in this sample. Use the order statistic formula discussed in class. Generate a plot of the function.

```{r, fig.width = 10, fig.height = 7}
curve(porder(x), -0.5,0.5, col = "blue",
      main = "Cumulative distribution function of the median (100th order statistic)",
      xlab = "value",
      ylab = "probability")
```

Q: Write an R function that is the quantile function for the median in this sample. (You have several options for how to write this function.) Generate a plot of the function.

```{r, fig.width = 10, fig.height = 7}
p <- seq(0.01, 0.99, by = 0.01)
d <- qorder(p,-0.2,0.2)
ggplot(d) +
  geom_line(aes(x = p, y = q), color = "red") +
  labs(title = "Quantile distribution of median (100th order statistic)",
       x = "probability", 
       y = "value") +
  theme_bw() +
  theme(plot.title= element_text(hjust=0.5))
```

Q: Simulate the sampling distribution for the median. Create a plot of the empirical CDF (ECDF). Overlay the plot of the ECDF with a plot of the CDF.

```{r, fig.width = 10, fig.height = 7}
b <- c()
set.seed(0)
for (i in 1:100) {
  n <- rnorm(200, mean = 0, sd= 1)
  b[i] <- quantile(n, 0.5)
}
p <- ecdf(b)
plot(p, main = "Probability density function of the median (100th order statistic)",
      xlab = "value",
      ylab = "density",xlim = c(-0.2,0.2))
curve(porder(x), col = "blue", add = TRUE)
```

Q: Using the simulated sampling distribution from the previous question, create a histogram (on the density scale). Overlay the histogram with a plot of the density function.

```{r, fig.width = 10, fig.height = 7}
hist(b,
     freq = FALSE,
     prob = TRUE,
     breaks = 10,
     xlab = "value", xlim = range(b),
     main = "Probability density function of the median (100th order statistic)")
curve(dorder(x), col = "blue", add = TRUE)
```

Q: One very common way to compare a random sample to a theoretical candidate distribution is the QQ plot. It is created by plotting quantiles of the theoretical distribution on the x-axis and empirical quantiles from the sample on the y-axis.

```{r, fig.width=10, fig.height=7}
b <- c()
set.seed(0)
for (i in 1:99) {
  n <- rnorm(200, mean = 0, sd= 1)
  b[i] <- quantile(n, 0.5)
}
b <- sort(b)
p <- seq(0.01,0.99, by = 0.01)
d <- qorder(p,-0.2,0.2)
g <- cbind(d, b)
x <- seq(-0.25,0.25, by = ((0.5)/(99 - 1)))
y <- x
ggplot(g) +
  geom_point(aes(x = q, y = b), col = "red") +
  geom_line(aes(x = x, y = y)) +
  labs(title = "QQplot",
       x = "Theoretical quantiles",
       y = "Sample quantiles")
```

Q: Modify the dorder, porder, and qorder functions so that the functions take a new parameter k (for the kth order statistic) so that the functions will work for any order statistic and not just the median.

```{r}
dorder <- function(x,k) {
  k*
  choose(200,k)
  (pnorm(x, mean = 0, sd = 1))^(k-1)*
  (1-pnorm(x, mean = 0, sd = 1))^(200-k)*
  dnorm(x, mean = 0, sd = 1)
}

porder <- function(x,k) {
  pbinom(k-1, 200, pnorm(x, mean = 0, sd = 1), lower.tail = FALSE)
}

qorder <- function(p,k, n1, n2) {
  r <- curve(porder(x,k),n1,n2)
  m <- mean(r$x)
  sd <- sd(r$x)
  q <- c()
  for (i in seq_along(p)) {
    q[i] <- qnorm(p[i], mean = m, sd = sd)
  }
  df <- data.frame(p = p, q = q)
  return(df)
}
```

Q: Generate the QQ plot for simulated data from the sampling distribution of the sample max and the theoretical largest order statistic distribution.

```{r, fig.width=10, fig.height=7}
b <- c()
set.seed(0)
for (i in 1:99) {
  n <- rnorm(200, mean = 0, sd= 1)
  b[i] <- quantile(n, 0.99)
}
b <- sort(b)
p <- seq(0.01, 0.99, by = 0.01)
d <- qorder(p, 200, 1.6,3.2)
g <- cbind(d, b)
g
x <- seq(1.6,3.2, by = ((1.6)/(99 - 1)))
y <- x
ggplot(g) +
  geom_point(aes(x = q, y = b), col = "red") +
  geom_line(aes(x = x, y = y)) +
  labs(title = "QQplot of maximum values",
       x = "Theoretical quantiles",
       y = "Sample quantiles") +
  theme_bw() +
  theme(plot.title = element_text(hjust=0.5))
```


Q: Modify the dorder, porder, and qorder functions so that the functions take new parameters dist and ... so that the functions will work for any continuous distribution that has d and p functions defined in R.

```{r}
dorder <- function(x,k, dist, ...) {
  f <- eval(parse(text = str_c("d", dist, sep = "")))
  Fm <- eval(parse(text = str_c("p", dist, sep = "")))
  k*
  choose(200,k)
  (Fm(x, ...))^(k-1)*
  (1-Fm(x, ...))^(200-k)*
  f(x, ...)
}

porder <- function(x,k, dist, ...) {
  Fm <- eval(parse(text = str_c("p", dist, sep = "")))
  pbinom(k-1, 200, Fm(x, ...), lower.tail = FALSE)
}

qorder <- function(p, k, n1, n2, dist, ...) {
  qm <- eval(parse(text = str_c("q", dist, sep = "")))
  r <- curve(porder(x,k),n1,n2)
  m <- mean(r$x)
  sd <- sd(r$x)
  q <- c()
  for (i in seq_along(p)) {
    q[i] <- qm(p[i], ...)
  }
  df <- data.frame(p = p, q = q)
  return(df)
}
```

Q: Use the newly modified functions to plot the probability and density functions for the sample min (N=200).

```{r, fig.width = 10, fig.height = 7}
curve(dorder(x, 1, dist = "norm", mean = 0, sd = 1), xlim = c(-5,-1), col = "blue",
      main = "Probability density function of the minimum value",
      xlab = "value",
      ylab = "density")

curve(porder(x, 1, dist = "norm", mean = 0, sd = 1), xlim = c(-5,-1), col = "blue",
      main = "Cumulative distribution function of the minimum value",
      xlab = "value",
      ylab = "probability")
```

# Conclusion

